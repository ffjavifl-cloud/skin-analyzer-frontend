<!-- ... (todo tu HTML y estilos igual que antes) ... -->

<script>
const ENDPOINT = "https://aging-analyzer.onrender.com/analyze";
const HEALTH_URL = "https://aging-analyzer.onrender.com/";
const PING_INTERVAL_MS = 10 * 60 * 1000;

function renderScore(name, value) {
  const score = Math.min(10, Math.max(0, value));
  return `<li><strong>${name}:</strong> ${score}/10</li>`;
}

function renderReport(data) {
  const m = data.metrics || {};
  const s = data.scores || {};

  const metricsList = [
    renderScore("Brillo", Math.round(m.brightness / 25.5)),
    renderScore("Contraste", Math.round(m.contrast / 25.5)),
    renderScore("Rojez", Math.round(m.redness_index / 10))
  ];

  const scoresList = [
    renderScore("Arrugas profundas", s.wrinkles_deep),
    renderScore("Líneas finas", s.lines_fine),
    renderScore("Pigmentación", s.pigmentation),
    renderScore("Sequedad", s.dryness),
    renderScore("Brillo excesivo", s.brightness_excess),
    renderScore("Poros visibles", s.pores_visible)
  ];

  document.getElementById("diagnosisText").innerText = data.diagnosis || "—";
  document.getElementById("scoreList").innerHTML = metricsList.concat(scoresList).join("");
}

function setServiceStatus(text, ok = true) {
  const el = document.getElementById("serviceStatus");
  if (!el) return;
  el.textContent = "Estado del servicio: " + text;
  el.style.color = ok ? "#2f7a2f" : "#b00020";
}

async function pingBackend() {
  try {
    const res = await fetch(HEALTH_URL, { method: "GET", cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const json = await res.json();
    if (json && json.status === "ok") {
      setServiceStatus("activo");
    } else {
      setServiceStatus("respuesta inesperada", false);
    }
  } catch (e) {
    setServiceStatus("no disponible: " + e.message, false);
  }
}

let pingTimer = null;

function startPing() {
  if (pingTimer) return;
  pingTimer = setInterval(pingBackend, PING_INTERVAL_MS);
}

function stopPing() {
  if (!pingTimer) return;
  clearInterval(pingTimer);
  pingTimer = null;
}

document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") {
    startPing();
    pingBackend();
  } else {
    stopPing();
  }
});

window.addEventListener("load", () => {
  pingBackend();
  startPing();
});

document.getElementById("uploadForm").addEventListener("submit", async (event) => {
  event.preventDefault();
  await pingBackend();

  const fileInput = document.getElementById("imageInput");
  const formData = new FormData();
  formData.append("file", fileInput.files[0]);

  document.getElementById("diagnosisText").innerText = "Analizando...";
  document.getElementById("scoreList").innerHTML = "";

  try {
    const response = await fetch(ENDPOINT, {
      method: "POST",
      body: formData,
      headers: {
        "Accept": "application/json"
      }
